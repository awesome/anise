<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />

	<title>Module: Anise::Annotation</title>

	<link rel="stylesheet" href="../rdoc.css" type="text/css" media="screen" />

	<script src="../js/jquery.js" type="text/javascript"
		charset="utf-8"></script>
	<script src="../js/thickbox-compressed.js" type="text/javascript"
		charset="utf-8"></script>
	<script src="../js/quicksearch.js" type="text/javascript"
		charset="utf-8"></script>
	<script src="../js/darkfish.js" type="text/javascript"
		charset="utf-8"></script>

</head>
<body class="module">

	<div id="metadata">
		<div id="file-metadata">
			<div id="file-list-section" class="section">
				<h3 class="section-header">In Files</h3>
				<div class="section-body">
					<ul>
					
						<li><a href="../lib/anise/annotation_rb.html?TB_iframe=true&amp;height=550&amp;width=785"
							class="thickbox" title="lib/anise/annotation.rb">lib/anise/annotation.rb</a></li>
					
					</ul>
				</div>
			</div>

			
		</div>

		<div id="class-metadata">

			<!-- Parent Class -->
			

			<!-- Namespace Contents -->
			

			<!-- Method Quickref -->
			
			<div id="method-list-section" class="section">
				<h3 class="section-header">Methods</h3>
				<ul class="link-list">
					
					<li><a href="#M000001">::append_features</a></li>
					
					<li><a href="#M000006">#ann</a></li>
					
					<li><a href="#M000008">#ann!</a></li>
					
					<li><a href="#M000003">#annotation</a></li>
					
					<li><a href="#M000012">#annotation_added</a></li>
					
					<li><a href="#M000004">#annotations</a></li>
					
				</ul>
			</div>
			

			<!-- Included Modules -->
			
		</div>

		<div id="project-metadata">
			
			
			<div id="fileindex-section" class="section project-section">
				<h3 class="section-header">Files</h3>
				<ul>
				
					<li class="file"><a href="../COPYING.html">COPYING</a></li>
				
					<li class="file"><a href="../HISTORY.html">HISTORY</a></li>
				
					<li class="file"><a href="../README_rdoc.html">README.rdoc</a></li>
				
					<li class="file"><a href="../TODO.html">TODO</a></li>
				
				</ul>
			</div>
			

			<div id="classindex-section" class="section project-section">
				<h3 class="section-header">Class Index
					<span class="search-toggle"><img src="../images/find.png"
						height="16" width="16" alt="[+]"
						title="show/hide quicksearch" /></span></h3>
				<form action="#" method="get" accept-charset="utf-8" class="initially-hidden">
				<fieldset>
					<legend>Quicksearch</legend>
					<input type="text" name="quicksearch" value=""
						class="quicksearch-field" />
				</fieldset>
				</form>

				<ul class="link-list">
				
					<li><a href="../Anise.html">Anise</a></li>
				
					<li><a href="../Anise/Annotation.html">Anise::Annotation</a></li>
				
					<li><a href="../Anise/Annotator.html">Anise::Annotator</a></li>
				
					<li><a href="../Anise/Attribute.html">Anise::Attribute</a></li>
				
				</ul>
				<div id="no-class-search-results" style="display: none;">No matching classes.</div>
			</div>

			
		</div>
	</div>

	<div id="documentation">
		<h1 class="module">Anise::Annotation</h1>

		<div id="description">
			<h1>Runtime Annotations</h1>
<p>
The <a href="Annotation.html">Annotation</a> module is the heart of the <a
href="../Anise.html">Anise</a> system. It provides the framework for
annotating class or module related objects, typically symbols representing
methods, with arbitrary metadata. These annotations do not do anything in
themselves. They are simply data. But you can put them to use. For instance
an attribute validator might check for an annotation called :valid and test
against it.
</p>
<h2>Synopsis</h2>
<pre>
  require 'anise/annotation'

  class X
    include Anise::Annotation

    attr :a

    ann :a, :desc =&gt; &quot;A Number&quot;
  end

  X.ann(:a, :desc)  #=&gt; &quot;A Number&quot;
</pre>
<p>
As stated, annotations need not only annotate methods, they are arbitrary,
so they can be used for any purpose. For example, we may want to annotate
instance variables.
</p>
<pre>
  class X
    include Anise::Annotation

    ann :@a, :valid =&gt; lambda{ |x| x.is_a?(Integer) }

    def validate
      instance_variables.each do |iv|
        if validator = self.class.ann(iv)[:valid]
          value = instance_variable_get(iv)
          unless validator.call(value)
            raise &quot;Invalid value #{value} for #{iv}&quot;
          end
        end
      end
    end
  end
</pre>
<p>
Or, we could even annotate the class itself.
</p>
<pre>
  class X
    include Anise::Annotation

    ann self, :valid =&gt; lambda{ |x| x.is_a?(Enumerable) }
  end
</pre>
<p>
Altough annotations are arbitrary they are tied to the class or module they
are defined against.
</p>

		</div>

		<!-- Constants -->
		

		<!-- Attributes -->
		

		<!-- Methods -->
		
		<div id="public-class-method-details" class="method-section section">
			<h3 class="section-header">Public Class Methods</h3>

		
			<div id="append-features-method" class="method-detail ">
				<a name="M000001"></a>

				<div class="method-heading">
				
					<span class="method-name">append_features</span><span
						class="method-args">(base)</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p class="missing-docs">(Not documented)</p>
					

					
					<div class="method-source-code"
						id="append-features-source">
<pre>
<span class="ruby-comment cmt"># File lib/anise/annotation.rb, line 73</span>
    <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">append_features</span>(<span class="ruby-identifier">base</span>)
      <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">base</span> <span class="ruby-operator">==</span> <span class="ruby-operator">::</span><span class="ruby-constant">Object</span>
        <span class="ruby-identifier">append_features</span>(<span class="ruby-operator">::</span><span class="ruby-constant">Module</span>)
      <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">base</span> <span class="ruby-operator">==</span> <span class="ruby-operator">::</span><span class="ruby-constant">Module</span>
        <span class="ruby-keyword kw">unless</span> <span class="ruby-operator">::</span><span class="ruby-constant">Module</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Annotation</span>
          <span class="ruby-keyword kw">super</span>
        <span class="ruby-keyword kw">end</span>
      <span class="ruby-keyword kw">else</span>
        <span class="ruby-identifier">base</span>.<span class="ruby-identifier">extend</span> <span class="ruby-keyword kw">self</span>
      <span class="ruby-keyword kw">end</span>
    <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				
			</div>

		
		</div>
	
		<div id="public-instance-method-details" class="method-section section">
			<h3 class="section-header">Public Instance Methods</h3>

		
			<div id="ann-method" class="method-detail ">
				<a name="M000006"></a>

				<div class="method-heading">
				
					<span class="method-name">ann</span><span
						class="method-args">(ref, keys_or_class=nil, keys=nil)</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p>
Set or read annotations.
</p>
					

					
					<div class="method-source-code"
						id="ann-source">
<pre>
<span class="ruby-comment cmt"># File lib/anise/annotation.rb, line 122</span>
    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ann</span>(<span class="ruby-identifier">ref</span>, <span class="ruby-identifier">keys_or_class</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">keys</span>=<span class="ruby-keyword kw">nil</span>)
      <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">annotation</span>(<span class="ruby-identifier">ref</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">keys_or_class</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">keys</span>

      <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Class</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">keys_or_class</span>
        <span class="ruby-identifier">keys</span> <span class="ruby-operator">||=</span> {}
        <span class="ruby-identifier">keys</span>[<span class="ruby-identifier">:class</span>] = <span class="ruby-identifier">keys_or_class</span>
      <span class="ruby-keyword kw">else</span>
        <span class="ruby-identifier">keys</span> = <span class="ruby-identifier">keys_or_class</span>
      <span class="ruby-keyword kw">end</span>

      <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Hash</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">keys</span>
        <span class="ruby-identifier">ref</span>  = <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">to_sym</span>
        <span class="ruby-identifier">keys</span> = <span class="ruby-identifier">keys</span>.<span class="ruby-identifier">inject</span>({}){ <span class="ruby-operator">|</span><span class="ruby-identifier">h</span>,(<span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span>)<span class="ruby-operator">|</span> <span class="ruby-identifier">h</span>[<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_sym</span>] = <span class="ruby-identifier">v</span>; <span class="ruby-identifier">h</span>} <span class="ruby-comment cmt">#rekey</span>
        <span class="ruby-identifier">annotations</span>[<span class="ruby-identifier">ref</span>] <span class="ruby-operator">||=</span> {}
        <span class="ruby-identifier">annotations</span>[<span class="ruby-identifier">ref</span>].<span class="ruby-identifier">update</span>(<span class="ruby-identifier">keys</span>)
        <span class="ruby-comment cmt"># callback</span>
        <span class="ruby-identifier">annotation_added</span>(<span class="ruby-identifier">ref</span>)
      <span class="ruby-keyword kw">else</span>
        <span class="ruby-identifier">key</span> = <span class="ruby-identifier">keys</span>.<span class="ruby-identifier">to_sym</span>
        <span class="ruby-identifier">annotation</span>(<span class="ruby-identifier">ref</span>)[<span class="ruby-identifier">key</span>]
      <span class="ruby-keyword kw">end</span>
    <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				
			</div>

		
			<div id="ann--method" class="method-detail ">
				<a name="M000008"></a>

				<div class="method-heading">
				
					<span class="method-name">ann!</span><span
						class="method-args">(ref, keys_or_class=nil, keys=nil)</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p>
To change an annotation&#8217;s value in place for a given class or module
it first must be duplicated, otherwise the change may effect annotations in
the class or module&#8217;s ancestors.
</p>
					

					
					<div class="method-source-code"
						id="ann--source">
<pre>
<span class="ruby-comment cmt"># File lib/anise/annotation.rb, line 149</span>
    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ann!</span>(<span class="ruby-identifier">ref</span>, <span class="ruby-identifier">keys_or_class</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">keys</span>=<span class="ruby-keyword kw">nil</span>)
      <span class="ruby-comment cmt">#return annotation(ref) unless keys_or_class or keys</span>
      <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">keys_or_class</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">keys</span>
        <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">annotations</span>[<span class="ruby-identifier">ref</span>] <span class="ruby-operator">||=</span> {}
      <span class="ruby-keyword kw">end</span>

      <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Class</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">keys_or_class</span>
        <span class="ruby-identifier">keys</span> <span class="ruby-operator">||=</span> {}
        <span class="ruby-identifier">keys</span>[<span class="ruby-identifier">:class</span>] = <span class="ruby-identifier">keys_or_class</span>
      <span class="ruby-keyword kw">else</span>
        <span class="ruby-identifier">keys</span> = <span class="ruby-identifier">keys_or_class</span>
      <span class="ruby-keyword kw">end</span>

      <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Hash</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">keys</span>
        <span class="ruby-identifier">ref</span>  = <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">to_sym</span>
        <span class="ruby-identifier">keys</span> = <span class="ruby-identifier">keys</span>.<span class="ruby-identifier">inject</span>({}){ <span class="ruby-operator">|</span><span class="ruby-identifier">h</span>,(<span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span>)<span class="ruby-operator">|</span> <span class="ruby-identifier">h</span>[<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_sym</span>] = <span class="ruby-identifier">v</span>; <span class="ruby-identifier">h</span>} <span class="ruby-comment cmt">#rekey</span>
        <span class="ruby-identifier">annotations</span>[<span class="ruby-identifier">ref</span>] <span class="ruby-operator">||=</span> {}
        <span class="ruby-identifier">annotations</span>[<span class="ruby-identifier">ref</span>].<span class="ruby-identifier">update</span>(<span class="ruby-identifier">keys</span>)
        <span class="ruby-comment cmt"># callback</span>
        <span class="ruby-identifier">annotation_added</span>(<span class="ruby-identifier">ref</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">method_defined?</span>(<span class="ruby-identifier">:annotation_added</span>)
      <span class="ruby-keyword kw">else</span>
        <span class="ruby-identifier">key</span> = <span class="ruby-identifier">keys</span>.<span class="ruby-identifier">to_sym</span>
        <span class="ruby-identifier">annotations</span>[<span class="ruby-identifier">ref</span>] <span class="ruby-operator">||=</span> {}
        <span class="ruby-keyword kw">begin</span>
          <span class="ruby-identifier">annotations</span>[<span class="ruby-identifier">ref</span>][<span class="ruby-identifier">key</span>] = <span class="ruby-identifier">annotation</span>(<span class="ruby-identifier">ref</span>)[<span class="ruby-identifier">key</span>].<span class="ruby-identifier">dup</span>
        <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">TypeError</span>
          <span class="ruby-identifier">annotations</span>[<span class="ruby-identifier">ref</span>][<span class="ruby-identifier">key</span>] = <span class="ruby-identifier">annotation</span>(<span class="ruby-identifier">ref</span>)[<span class="ruby-identifier">key</span>]
        <span class="ruby-keyword kw">end</span>
      <span class="ruby-keyword kw">end</span>
    <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				
			</div>

		
			<div id="annotation-method" class="method-detail ">
				<a name="M000003"></a>

				<div class="method-heading">
				
					<span class="method-name">annotation</span><span
						class="method-args">(ref=nil)</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p>
Lookup an annotation. Unlike +annotations[ref]+ this provides a complete
annotation <em>heritage</em>, pulling annotations of the same reference
name from ancestor classes and modules.
</p>
					

					
					<div class="method-source-code"
						id="annotation-source">
<pre>
<span class="ruby-comment cmt"># File lib/anise/annotation.rb, line 90</span>
    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">annotation</span>(<span class="ruby-identifier">ref</span>=<span class="ruby-keyword kw">nil</span>)
      <span class="ruby-keyword kw">return</span>(<span class="ruby-ivar">@annotations</span> <span class="ruby-operator">||=</span> {}) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">nil?</span>

      <span class="ruby-identifier">ref</span> = <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">to_sym</span>
      <span class="ruby-identifier">ann</span> = {}
      <span class="ruby-identifier">ancestors</span>.<span class="ruby-identifier">reverse_each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">anc</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">anc</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Annotation</span>)
        <span class="ruby-comment cmt">#anc.annotations[ref] ||= {}</span>
        <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">anc</span>.<span class="ruby-identifier">annotations</span>[<span class="ruby-identifier">ref</span>]
          <span class="ruby-identifier">ann</span>.<span class="ruby-identifier">update</span>(<span class="ruby-identifier">anc</span>.<span class="ruby-identifier">annotations</span>[<span class="ruby-identifier">ref</span>]) <span class="ruby-comment cmt">#.merge(ann)</span>
        <span class="ruby-keyword kw">end</span>
      <span class="ruby-keyword kw">end</span>
      <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">ann</span>
      <span class="ruby-comment cmt">#ancs = ancestors.select{ |a| a.is_a?(Annotations) }</span>
      <span class="ruby-comment cmt">#ancs.inject({}) do |memo, ancestor|</span>
      <span class="ruby-comment cmt">#  ancestor.annotations[ref] ||= {}</span>
      <span class="ruby-comment cmt">#  ancestor.annotations[ref].merge(memo)</span>
      <span class="ruby-comment cmt">#end</span>
    <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				
				<div class="aliases">
					Also aliased as: <a href="Annotation.html#M000004">annotations</a>
				</div>
				
			</div>

		
			<div id="annotation-added-method" class="method-detail ">
				<a name="M000012"></a>

				<div class="method-heading">
				
					<span class="method-name">annotation_added</span><span
						class="method-args">(name)</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p>
callback method
</p>
					

					
					<div class="method-source-code"
						id="annotation-added-source">
<pre>
<span class="ruby-comment cmt"># File lib/anise/annotation.rb, line 181</span>
    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">annotation_added</span>(<span class="ruby-identifier">name</span>)
      <span class="ruby-keyword kw">super</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">defined?</span>(<span class="ruby-keyword kw">super</span>)
    <span class="ruby-keyword kw">end</span></pre>
					</div>
					
				</div>

				
			</div>

		
			<div id="annotations-method" class="method-detail method-alias">
				<a name="M000004"></a>

				<div class="method-heading">
				
					<span class="method-name">annotations</span><span
						class="method-args">(ref=nil)</span>
					<span class="method-click-advice">click to toggle source</span>
				
				</div>

				<div class="method-description">
					
					<p>
Alias for <a href="Annotation.html#M000003">annotation</a>
</p>
					

					
				</div>

				
			</div>

		
		</div>
	

	</div>


	<div id="rdoc-debugging-section-dump" class="debugging-section">
	
		<p>Disabled; run with --debug to generate this.</p>
	
	</div>

	<div id="validator-badges">
		<p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
		<p><small>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish
			Rdoc Generator</a> 1.1.6</small>.</p>
	</div>

</body>
</html>

