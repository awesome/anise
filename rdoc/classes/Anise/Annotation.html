<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
  <head>
    <title>: Anise::Annotation [Anise API]</title>
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
    <link href='../../rdoc-style.css' media='screen' rel='stylesheet' type='text/css'>
    <script type='text/javascript'>
      //<![CDATA[
        function popupCode(url) {
          window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
        }
        
        function toggleCode(id) {
          var code = document.getElementById(id)
        
          code.style.display = code.style.display != 'block' ? 'block' : 'none'
          return true
        }
        
        // Make codeblocks hidden by default
        document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
      //]]>
    </script>
  </head>
  <body class='page'>
    <div class='class' id='wrapper'>
      <div class='header'>
        <div class='name'>
          <span class='type'>Module</span>
          Anise::Annotation
        </div>
        <ol class='paths'>
          <li>
            <a href="../../files/lib/anise/annotation_rb.html">lib/anise/annotation.rb</a>
          </li>
        </ol>
      </div>
      <div id='content'>
        <div id='text'>
          <div id='description'>
            <h1>Runtime Annotations</h1>
            <p>
            The <a href="Annotation.html">Annotation</a> module is the heart of the <a
            href="../Anise.html">Anise</a> system. It provides the framework for
            annotating class or module related objects, typically symbols representing
            methods, with arbitrary metadata. These annotations do not do anything in
            themselves. They are simply data. But you can put them to use. For instance
            an attribute validator might check for an annotation called :valid and test
            against it.
            </p>
            <h2>Synopsis</h2>
            <pre>require 'anise/annotation'&#x000A;&#x000A;class X&#x000A;  include Anise::Annotation&#x000A;&#x000A;  attr :a&#x000A;&#x000A;  ann :a, :desc =&gt; &quot;A Number&quot;&#x000A;end&#x000A;&#x000A;X.ann(:a, :desc)  #=&gt; &quot;A Number&quot;</pre>
            <p>
            As stated, annotations need not only annotate methods, they are arbitrary,
            so they can be used for any purpose. For example, we may want to annotate
            instance variables.
            </p>
            <pre>class X&#x000A;  include Anise::Annotation&#x000A;&#x000A;  ann :@a, :valid =&gt; lambda{ |x| x.is_a?(Integer) }&#x000A;&#x000A;  def validate&#x000A;    instance_variables.each do |iv|&#x000A;      if validator = self.class.ann(iv)[:valid]&#x000A;        value = instance_variable_get(iv)&#x000A;        unless validator.call(value)&#x000A;          raise &quot;Invalid value #{value} for #{iv}&quot;&#x000A;        end&#x000A;      end&#x000A;    end&#x000A;  end&#x000A;end</pre>
            <p>
            Or, we could even annotate the class itself.
            </p>
            <pre>class X&#x000A;  include Anise::Annotation&#x000A;&#x000A;  ann self, :valid =&gt; lambda{ |x| x.is_a?(Enumerable) }&#x000A;end</pre>
            <p>
            Altough annotations are arbitrary they are tied to the class or module they
            are defined against.
            </p>
          </div>
          <div id='method-list'>
            <h2>Methods</h2>
            <h3>public class</h3>
            <ol>
              <li><a href="#M000002">append_features</a></li>
            </ol>
            <h3>public instance</h3>
            <ol>
              <li><a href="#M000005">ann</a></li>
              <li><a href="#M000006">ann!</a></li>
              <li><a href="#M000003">annotation</a></li>
              <li><a href="#M000007">annotation_added</a></li>
              <li><a href="#M000004">annotations</a></li>
            </ol>
          </div>
          <div id='section'>
            <div id='methods'>
              <h2>Public class methods</h2>
              <div class='public-class method' id='method-M000002'>
                <a name='M000002'>      </a>
                <div class='synopsis'>
                  <span class='name'>append_features</span>
                  <span class='arguments'>(base)</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000002-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000002-source'><span class="ruby-comment cmt"># File lib/anise/annotation.rb, line 73</span>&#x000A;    <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">append_features</span>(<span class="ruby-identifier">base</span>)&#x000A;      <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">base</span> <span class="ruby-operator">==</span> <span class="ruby-operator">::</span><span class="ruby-constant">Object</span>&#x000A;        <span class="ruby-identifier">append_features</span>(<span class="ruby-operator">::</span><span class="ruby-constant">Module</span>)&#x000A;      <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">base</span> <span class="ruby-operator">==</span> <span class="ruby-operator">::</span><span class="ruby-constant">Module</span>&#x000A;        <span class="ruby-keyword kw">unless</span> <span class="ruby-operator">::</span><span class="ruby-constant">Module</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Annotation</span>&#x000A;          <span class="ruby-keyword kw">super</span>&#x000A;        <span class="ruby-keyword kw">end</span>&#x000A;      <span class="ruby-keyword kw">else</span>&#x000A;        <span class="ruby-identifier">base</span>.<span class="ruby-identifier">extend</span> <span class="ruby-keyword kw">self</span>&#x000A;      <span class="ruby-keyword kw">end</span>&#x000A;    <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <h2>Public instance methods</h2>
              <div class='public-instance method' id='method-M000005'>
                <a name='M000005'>      </a>
                <div class='synopsis'>
                  <span class='name'>ann</span>
                  <span class='arguments'>(ref, keys_or_class=nil, keys=nil)</span>
                </div>
                <div class='description'>
                  <p>
                  Set or read annotations.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000005-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000005-source'><span class="ruby-comment cmt"># File lib/anise/annotation.rb, line 122</span>&#x000A;    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ann</span>(<span class="ruby-identifier">ref</span>, <span class="ruby-identifier">keys_or_class</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">keys</span>=<span class="ruby-keyword kw">nil</span>)&#x000A;      <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">annotation</span>(<span class="ruby-identifier">ref</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">keys_or_class</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">keys</span>&#x000A;&#x000A;      <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Class</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">keys_or_class</span>&#x000A;        <span class="ruby-identifier">keys</span> <span class="ruby-operator">||=</span> {}&#x000A;        <span class="ruby-identifier">keys</span>[<span class="ruby-identifier">:class</span>] = <span class="ruby-identifier">keys_or_class</span>&#x000A;      <span class="ruby-keyword kw">else</span>&#x000A;        <span class="ruby-identifier">keys</span> = <span class="ruby-identifier">keys_or_class</span>&#x000A;      <span class="ruby-keyword kw">end</span>&#x000A;&#x000A;      <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Hash</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">keys</span>&#x000A;        <span class="ruby-identifier">ref</span>  = <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">to_sym</span>&#x000A;        <span class="ruby-identifier">keys</span> = <span class="ruby-identifier">keys</span>.<span class="ruby-identifier">inject</span>({}){ <span class="ruby-operator">|</span><span class="ruby-identifier">h</span>,(<span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span>)<span class="ruby-operator">|</span> <span class="ruby-identifier">h</span>[<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_sym</span>] = <span class="ruby-identifier">v</span>; <span class="ruby-identifier">h</span>} <span class="ruby-comment cmt">#rekey</span>&#x000A;        <span class="ruby-identifier">annotations</span>[<span class="ruby-identifier">ref</span>] <span class="ruby-operator">||=</span> {}&#x000A;        <span class="ruby-identifier">annotations</span>[<span class="ruby-identifier">ref</span>].<span class="ruby-identifier">update</span>(<span class="ruby-identifier">keys</span>)&#x000A;        <span class="ruby-comment cmt"># callback</span>&#x000A;        <span class="ruby-identifier">annotation_added</span>(<span class="ruby-identifier">ref</span>)&#x000A;      <span class="ruby-keyword kw">else</span>&#x000A;        <span class="ruby-identifier">key</span> = <span class="ruby-identifier">keys</span>.<span class="ruby-identifier">to_sym</span>&#x000A;        <span class="ruby-identifier">annotation</span>(<span class="ruby-identifier">ref</span>)[<span class="ruby-identifier">key</span>]&#x000A;      <span class="ruby-keyword kw">end</span>&#x000A;    <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000006'>
                <a name='M000006'>      </a>
                <div class='synopsis'>
                  <span class='name'>ann!</span>
                  <span class='arguments'>(ref, keys_or_class=nil, keys=nil)</span>
                </div>
                <div class='description'>
                  <p>
                  To change an annotation&#8217;s value in place for a given class or module
                  it first must be duplicated, otherwise the change may effect annotations in
                  the class or module&#8217;s ancestors.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000006-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000006-source'><span class="ruby-comment cmt"># File lib/anise/annotation.rb, line 149</span>&#x000A;    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ann!</span>(<span class="ruby-identifier">ref</span>, <span class="ruby-identifier">keys_or_class</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">keys</span>=<span class="ruby-keyword kw">nil</span>)&#x000A;      <span class="ruby-comment cmt">#return annotation(ref) unless keys_or_class or keys</span>&#x000A;      <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">keys_or_class</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">keys</span>&#x000A;        <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">annotations</span>[<span class="ruby-identifier">ref</span>] <span class="ruby-operator">||=</span> {}&#x000A;      <span class="ruby-keyword kw">end</span>&#x000A;&#x000A;      <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Class</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">keys_or_class</span>&#x000A;        <span class="ruby-identifier">keys</span> <span class="ruby-operator">||=</span> {}&#x000A;        <span class="ruby-identifier">keys</span>[<span class="ruby-identifier">:class</span>] = <span class="ruby-identifier">keys_or_class</span>&#x000A;      <span class="ruby-keyword kw">else</span>&#x000A;        <span class="ruby-identifier">keys</span> = <span class="ruby-identifier">keys_or_class</span>&#x000A;      <span class="ruby-keyword kw">end</span>&#x000A;&#x000A;      <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Hash</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">keys</span>&#x000A;        <span class="ruby-identifier">ref</span>  = <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">to_sym</span>&#x000A;        <span class="ruby-identifier">keys</span> = <span class="ruby-identifier">keys</span>.<span class="ruby-identifier">inject</span>({}){ <span class="ruby-operator">|</span><span class="ruby-identifier">h</span>,(<span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span>)<span class="ruby-operator">|</span> <span class="ruby-identifier">h</span>[<span class="ruby-identifier">k</span>.<span class="ruby-identifier">to_sym</span>] = <span class="ruby-identifier">v</span>; <span class="ruby-identifier">h</span>} <span class="ruby-comment cmt">#rekey</span>&#x000A;        <span class="ruby-identifier">annotations</span>[<span class="ruby-identifier">ref</span>] <span class="ruby-operator">||=</span> {}&#x000A;        <span class="ruby-identifier">annotations</span>[<span class="ruby-identifier">ref</span>].<span class="ruby-identifier">update</span>(<span class="ruby-identifier">keys</span>)&#x000A;        <span class="ruby-comment cmt"># callback</span>&#x000A;        <span class="ruby-identifier">annotation_added</span>(<span class="ruby-identifier">ref</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">method_defined?</span>(<span class="ruby-identifier">:annotation_added</span>)&#x000A;      <span class="ruby-keyword kw">else</span>&#x000A;        <span class="ruby-identifier">key</span> = <span class="ruby-identifier">keys</span>.<span class="ruby-identifier">to_sym</span>&#x000A;        <span class="ruby-identifier">annotations</span>[<span class="ruby-identifier">ref</span>] <span class="ruby-operator">||=</span> {}&#x000A;        <span class="ruby-keyword kw">begin</span>&#x000A;          <span class="ruby-identifier">annotations</span>[<span class="ruby-identifier">ref</span>][<span class="ruby-identifier">key</span>] = <span class="ruby-identifier">annotation</span>(<span class="ruby-identifier">ref</span>)[<span class="ruby-identifier">key</span>].<span class="ruby-identifier">dup</span>&#x000A;        <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">TypeError</span>&#x000A;          <span class="ruby-identifier">annotations</span>[<span class="ruby-identifier">ref</span>][<span class="ruby-identifier">key</span>] = <span class="ruby-identifier">annotation</span>(<span class="ruby-identifier">ref</span>)[<span class="ruby-identifier">key</span>]&#x000A;        <span class="ruby-keyword kw">end</span>&#x000A;      <span class="ruby-keyword kw">end</span>&#x000A;    <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000003'>
                <a name='M000003'>      </a>
                <div class='synopsis'>
                  <span class='name'>annotation</span>
                  <span class='arguments'>(ref=nil)</span>
                </div>
                <div class='description'>
                  <p>
                  Lookup an annotation. Unlike +annotations[ref]+ this provides a complete
                  annotation <em>heritage</em>, pulling annotations of the same reference
                  name from ancestor classes and modules.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000003-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000003-source'><span class="ruby-comment cmt"># File lib/anise/annotation.rb, line 90</span>&#x000A;    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">annotation</span>(<span class="ruby-identifier">ref</span>=<span class="ruby-keyword kw">nil</span>)&#x000A;      <span class="ruby-keyword kw">return</span>(<span class="ruby-ivar">@annotations</span> <span class="ruby-operator">||=</span> {}) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">nil?</span>&#x000A;&#x000A;      <span class="ruby-identifier">ref</span> = <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">to_sym</span>&#x000A;      <span class="ruby-identifier">ann</span> = {}&#x000A;      <span class="ruby-identifier">ancestors</span>.<span class="ruby-identifier">reverse_each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">anc</span><span class="ruby-operator">|</span>&#x000A;        <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">anc</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Annotation</span>)&#x000A;        <span class="ruby-comment cmt">#anc.annotations[ref] ||= {}</span>&#x000A;        <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">anc</span>.<span class="ruby-identifier">annotations</span>[<span class="ruby-identifier">ref</span>]&#x000A;          <span class="ruby-identifier">ann</span>.<span class="ruby-identifier">update</span>(<span class="ruby-identifier">anc</span>.<span class="ruby-identifier">annotations</span>[<span class="ruby-identifier">ref</span>]) <span class="ruby-comment cmt">#.merge(ann)</span>&#x000A;        <span class="ruby-keyword kw">end</span>&#x000A;      <span class="ruby-keyword kw">end</span>&#x000A;      <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">ann</span>&#x000A;      <span class="ruby-comment cmt">#ancs = ancestors.select{ |a| a.is_a?(Annotations) }</span>&#x000A;      <span class="ruby-comment cmt">#ancs.inject({}) do |memo, ancestor|</span>&#x000A;      <span class="ruby-comment cmt">#  ancestor.annotations[ref] ||= {}</span>&#x000A;      <span class="ruby-comment cmt">#  ancestor.annotations[ref].merge(memo)</span>&#x000A;      <span class="ruby-comment cmt">#end</span>&#x000A;    <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000007'>
                <a name='M000007'>      </a>
                <div class='synopsis'>
                  <span class='name'>annotation_added</span>
                  <span class='arguments'>(name)</span>
                </div>
                <div class='description'>
                  <p>
                  callback method
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000007-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000007-source'><span class="ruby-comment cmt"># File lib/anise/annotation.rb, line 181</span>&#x000A;    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">annotation_added</span>(<span class="ruby-identifier">name</span>)&#x000A;      <span class="ruby-keyword kw">super</span> <span class="ruby-keyword kw">if</span> <span class="ruby-keyword kw">defined?</span>(<span class="ruby-keyword kw">super</span>)&#x000A;    <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='public-instance method' id='method-M000004'>
                <a name='M000004'>      </a>
                <div class='synopsis'>
                  <span class='name'>annotations</span>
                  <span class='arguments'>(ref=nil)</span>
                </div>
                <div class='description'>
                  <p>
                  Alias for <a href="Annotation.html#M000003">annotation</a>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id='footer-push'></div>
    </div>
    <div id='footer'>
      <a href="http://github.com/mislav/hanna/tree/master"><strong>Hanna</strong> RDoc template</a>
    </div>
  </body>
</html>
